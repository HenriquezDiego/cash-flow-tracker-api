{
  "openapi": "3.0.3",
  "info": {
    "title": "Cash Flow Tracker API",
    "version": "1.0.0",
    "description": "API para gestión de gastos, presupuestos, categorías, gastos fijos y deudas con integración a Google Sheets.",
    "contact": {
      "name": "API Support"
    }
  },
  "servers": [
    { "url": "/" }
  ],
  "tags": [
    {
      "name": "Authentication",
      "description": "Endpoints de autenticación con Google OAuth"
    },
    {
      "name": "Categories",
      "description": "Gestión de categorías de gastos"
    },
    {
      "name": "Expenses",
      "description": "Gestión de gastos y transacciones"
    },
    {
      "name": "Fixed Expenses",
      "description": "Gestión de gastos fijos recurrentes"
    },
    {
      "name": "Budget",
      "description": "Gestión de presupuestos mensuales"
    },
    {
      "name": "Debts",
      "description": "Gestión de deudas y tarjetas de crédito"
    },
    {
      "name": "Meta",
      "description": "Metadatos y utilidades del sistema"
    }
  ],
  "paths": {
    "/api/meta/expenses/statuses": {
      "get": {
        "tags": ["Meta"],
        "summary": "Get allowed expense statuses",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": { "type": "array", "items": { "type": "string" } }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/meta/expenses/entry-types": {
      "get": {
        "tags": ["Meta"],
        "summary": "Get allowed expense entry types",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": { "type": "array", "items": { "type": "string" } }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/health": {
      "get": {
        "tags": ["Meta"],
        "summary": "Health check",
        "responses": {
          "200": {
            "description": "OK"
          }
        }
      }
    },
    "/api/categories": {
      "get": {
        "tags": ["Categories"],
        "summary": "List categories",
        "responses": {
          "200": {
            "description": "Categories list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListCategoriesResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Categories"],
        "summary": "Create category",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Category name",
                    "example": "Alimentación"
                  },
                  "color": {
                    "type": "string",
                    "description": "Hex color code",
                    "example": "#FF5733"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Category created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "message": {"type": "string"},
                    "data": {
                      "type": "object",
                      "properties": {
                        "id": {"type": "integer"},
                        "name": {"type": "string"},
                        "color": {"type": "string"}
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/categories/{id}": {
      "put": {
        "tags": ["Categories"],
        "summary": "Update category",
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {"type": "integer"},
            "description": "Category ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Category name"
                  },
                  "color": {
                    "type": "string",
                    "description": "Hex color code"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Category updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "message": {"type": "string"},
                    "data": {
                      "type": "object",
                      "properties": {
                        "id": {"type": "integer"},
                        "name": {"type": "string"},
                        "color": {"type": "string"}
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": ["Categories"],
        "summary": "Delete category",
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {"type": "integer"},
            "description": "Category ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Category deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "message": {"type": "string"},
                    "data": {
                      "type": "object",
                      "properties": {
                        "id": {"type": "integer"},
                        "deleted": {"type": "boolean"}
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/expenses": {
      "get": {
        "tags": ["Expenses"],
        "summary": "List expenses",
        "responses": {
          "200": {
            "description": "Expenses list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListExpensesResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Expenses"],
        "summary": "Create expense",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CreateExpenseRequest" } } }
        },
        "responses": {
          "201": { "description": "Created" }
        }
      }
    },
    "/api/expenses/batch": {
      "post": {
        "tags": ["Expenses"],
        "summary": "Create multiple expenses",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CreateExpensesBulkRequest" } } }
        },
        "responses": { "201": { "description": "Created" } }
      }
    },
    "/api/expenses/{id}": {
      "put": {
        "tags": ["Expenses"],
        "summary": "Update expense",
        "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateExpenseRequest" } } } },
        "responses": { "200": { "description": "Updated" } }
      },
      "delete": {
        "tags": ["Expenses"],
        "summary": "Delete expense",
        "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ],
        "responses": { "200": { "description": "Deleted" } }
      }
    },
    "/api/fixed-expenses": {
      "get": { "tags": ["Fixed Expenses"], "summary": "List fixed expenses", "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ListFixedExpensesResponse" } } } } } },
      "post": { "tags": ["Fixed Expenses"], "summary": "Create fixed expense", "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CreateFixedExpenseRequest" } } } }, "responses": { "201": { "description": "Created" } } }
    },
    "/api/fixed-expenses/{id}": {
      "put": { "tags": ["Fixed Expenses"], "summary": "Update fixed expense", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ], "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateFixedExpenseRequest" } } } }, "responses": { "200": { "description": "Updated" } } },
      "delete": { "tags": ["Fixed Expenses"], "summary": "Delete fixed expense", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ], "responses": { "200": { "description": "Deleted" } } }
    },
    "/api/generate-fixed-expenses": {
      "post": { "tags": ["Fixed Expenses"], "summary": "Generate fixed expenses for a month", "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/GenerateFixedExpensesRequest" } } } }, "responses": { "201": { "description": "Created" } } }
    },
    "/api/budget": {
      "get": { "tags": ["Budget"], "summary": "Get budget", "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ListBudgetResponse" } } } } } },
      "put": { "tags": ["Budget"], "summary": "Update budget", "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateBudgetRequest" } } } }, "responses": { "200": { "description": "Updated" } } }
    },
    "/api/debts": {
      "get": { "tags": ["Debts"], "summary": "List debts", "responses": { "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ListDebtsResponse" } } } } } },
      "post": { "tags": ["Debts"], "summary": "Create debt", "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CreateDebtRequest" } } } }, "responses": { "201": { "description": "Created" } } }
    },
    "/api/debts/{id}": {
      "put": { "tags": ["Debts"], "summary": "Update debt", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ], "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UpdateDebtRequest" } } } }, "responses": { "200": { "description": "Updated" } } },
      "delete": { "tags": ["Debts"], "summary": "Delete debt", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ], "responses": { "200": { "description": "Deleted" } } }
    },
    "/api/debts/{id}/summary": {
      "get": { "tags": ["Debts"], "summary": "Debt summary", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } } ], "responses": { "200": { "description": "OK" } } }
    },
    "/api/debts/summary": {
      "get": { "tags": ["Debts"], "summary": "All debts summaries", "responses": { "200": { "description": "OK" } } }
    },
    "/api/debts/{id}/installments": {
      "get": { "tags": ["Debts"], "summary": "Debt installments", "parameters": [ { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }, { "in": "query", "name": "months", "required": true, "schema": { "type": "integer", "minimum": 1 } }, { "in": "query", "name": "start", "required": false, "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" } } ], "responses": { "200": { "description": "OK" } } }
    }
    ,
    "/api/debts/{id}/statements": {
      "post": {
        "tags": ["Debts"],
        "summary": "Create statement for period",
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } },
          { "in": "query", "name": "period", "required": false, "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" } },
          { "in": "query", "name": "date", "required": false, "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" } },
          { "in": "query", "name": "recompute", "required": false, "schema": { "type": "boolean" } }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "examples": {
                  "createdStatement": {
                    "summary": "Statement created for 2025-08",
                    "value": {
                      "success": true,
                      "idempotency": { "key": "visa-1234|2025-08-22", "status": "created" },
                      "data": {
                        "debtId": "visa-1234",
                        "statementDate": "2025-08-22",
                        "dueDate": "2025-09-16",
                        "previousBalance": 315.14,
                        "charges": 1115.38,
                        "interests": 0.0,
                        "payments": 562.67,
                        "statementBalance": 867.85,
                        "bonifiableInterest": 20.62,
                        "installmentBalance": 888.47,
                        "annualEffectiveRate": 0.441,
                        "termMonths": null,
                        "periodDays": 31,
                        "paymentMade": 0.0,
                        "interestBreakdown": { "interestSobreSaldo": 0.0, "interestBonificable": 20.62 }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/debts/{id}/statement-preview": {
      "get": {
        "tags": ["Debts"],
        "summary": "Preview statement without persisting",
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string" } },
          { "in": "query", "name": "period", "required": false, "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" } },
          { "in": "query", "name": "date", "required": false, "schema": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" } },
          { "in": "query", "name": "recompute", "required": false, "schema": { "type": "boolean" }, "description": "If true, recompute even if stored record exists" }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "examples": {
                  "cached": {
                    "summary": "Returns stored statement when recompute=false",
                    "value": {
                      "success": true,
                      "cached": true,
                      "data": {
                        "debtId": "visa-1234",
                        "statementDate": "2025-08-22",
                        "dueDate": "2025-09-16",
                        "previousBalance": 315.14,
                        "charges": 1115.38,
                        "interests": 0.0,
                        "payments": 562.67,
                        "statementBalance": 867.85,
                        "bonifiableInterest": 20.62,
                        "installmentBalance": 888.47,
                        "annualEffectiveRate": 0.441,
                        "termMonths": null,
                        "periodDays": 31,
                        "paymentMade": 0.0
                      }
                    }
                  },
                  "recomputed": {
                    "summary": "Recompute result when recompute=true",
                    "value": {
                      "success": true,
                      "data": {
                        "debtId": "visa-1234",
                        "statementDate": "2025-09-22",
                        "dueDate": "2025-10-16",
                        "previousBalance": 867.85,
                        "charges": 250.00,
                        "interests": 10.12,
                        "payments": 100.00,
                        "statementBalance": 1027.97,
                        "bonifiableInterest": 5.34,
                        "installmentBalance": 1033.31,
                        "annualEffectiveRate": 0.441,
                        "termMonths": null,
                        "periodDays": 31,
                        "paymentMade": 0.0,
                        "interestBreakdown": { "interestSobreSaldo": 10.12, "interestBonificable": 5.34 }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT token obtained from /api/auth/google"
      }
    },
    "schemas": {
      "Expense": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "date": { "type": "string", "format": "date" },
          "description": { "type": "string" },
          "amount": { "type": "number" },
          "categoryId": { "type": "integer" },
          "isFixed": { "type": "boolean" },
          "fixedExpenseId": { "type": "string", "nullable": true },
          "debtId": { "type": "string", "nullable": true, "description": "If present, expense is credit-related. entryType becomes required." },
          "entryType": { "type": "string", "nullable": true, "enum": ["charge", "payment"], "description": "Required when debtId is present. Omit otherwise." },
          "status": { "type": "string", "nullable": true, "enum": ["pending", "paid", "cancelled", "skipped", "overdue"] }
        }
      },
      "FixedExpense": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "amount": { "type": "number" },
          "categoryId": { "type": "integer" },
          "dayOfMonth": { "type": "integer", "minimum": 1, "maximum": 31 },
          "active": { "type": "boolean" }
        }
      },
      "BudgetItem": {
        "type": "object",
        "properties": {
          "month": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" },
          "amount": { "type": "number" }
        }
      },
      "Category": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "type": { "type": "string" },
          "parentId": { "type": "string", "nullable": true }
        }
      },
      "Debt": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "issuer": { "type": "string" },
          "creditLimit": { "type": "number" },
          "balance": { "type": "number" },
          "dueDay": { "type": "integer" },
          "cutOffDay": { "type": "integer" },
          "maskPan": { "type": "string" },
          "interesEfectivo": { "type": "number" },
          "brand": { "type": "string" },
          "active": { "type": "boolean" }
        }
      },
      "ListExpensesResponse": { "type": "object", "properties": { "success": { "type": "boolean" }, "count": { "type": "integer" }, "data": { "type": "array", "items": { "$ref": "#/components/schemas/Expense" } } } },
      "CreateExpenseRequest": { "$ref": "#/components/schemas/Expense" },
      "CreateExpensesBulkRequest": { "type": "object", "properties": { "expenses": { "type": "array", "items": { "$ref": "#/components/schemas/Expense" } } } },
      "UpdateExpenseRequest": { "$ref": "#/components/schemas/Expense" },
      "ListFixedExpensesResponse": { "type": "object", "properties": { "success": { "type": "boolean" }, "count": { "type": "integer" }, "data": { "type": "array", "items": { "$ref": "#/components/schemas/FixedExpense" } } } },
      "CreateFixedExpenseRequest": { "$ref": "#/components/schemas/FixedExpense" },
      "UpdateFixedExpenseRequest": { "$ref": "#/components/schemas/FixedExpense" },
      "GenerateFixedExpensesRequest": { "type": "object", "properties": { "month": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" } }, "required": ["month"] },
      "ListBudgetResponse": { "type": "object", "properties": { "success": { "type": "boolean" }, "count": { "type": "integer" }, "data": { "type": "array", "items": { "$ref": "#/components/schemas/BudgetItem" } } } },
      "UpdateBudgetRequest": { "$ref": "#/components/schemas/BudgetItem" },
      "ListCategoriesResponse": { "type": "object", "properties": { "success": { "type": "boolean" }, "count": { "type": "integer" }, "data": { "type": "array", "items": { "$ref": "#/components/schemas/Category" } } } },
      "ListDebtsResponse": { "type": "object", "properties": { "success": { "type": "boolean" }, "count": { "type": "integer" }, "data": { "type": "array", "items": { "$ref": "#/components/schemas/Debt" } } } }
    }
  }
}


